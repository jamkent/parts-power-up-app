<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Parts Power Up</title>
<style>
/* Styles are unchanged */
@font-face {
    font-family: 'Universal Sans';
    src: local('Universal Sans'), sans-serif;
}
body { margin:0; font-family:'Universal Sans', sans-serif; background:radial-gradient(circle at top,#0f172a,#020617); color:white; }
.container { max-width:1000px;margin:auto;padding:20px; }
h1{text-align:center;margin-bottom:0;font-size:32px;}
h2{text-align:center;margin-top:5px;font-weight:400;color:#a1a1aa;font-size:16px;}
.controls{text-align:center;margin-bottom:15px;}
select,input{padding:10px;border-radius:8px;border:none;margin:5px;font-family:'Universal Sans', sans-serif;}
button{padding:10px 15px;border-radius:8px;border:none;background:linear-gradient(135deg,#ef4444,#b91c1c);color:white;font-family:'Universal Sans', sans-serif;cursor:pointer;}
button:hover{transform:scale(1.05);}
.progress{width:100%;height:20px;background:#1e293b;border-radius:10px;overflow:hidden;margin:10px 0;}
.progress-fill{height:100%;background:linear-gradient(90deg,red,orange,yellow,green);width:0%;transition:width 0.3s ease;}
.grid{display:grid;grid-template-columns:repeat(10,40px);gap:6px;justify-content:center;margin-top:20px;}
.cell{width:40px;height:40px;background:#1e293b;border-radius:8px;transition:0.2s;}
.tier1{background:#ef4444;}
.tier2{background:#f97316;}
.tier3{background:#eab308;}
.tier4{background:#22c55e;box-shadow:0 0 10px #22c55e;}
.badges{text-align:center;margin-top:10px;}
.badge{display:inline-block;padding:6px 12px;margin:3px;border-radius:12px;background:#1e293b;font-size:12px;font-weight:bold;}
.unlocked{background:#22c55e;box-shadow:0 0 10px #22c55e;color:#000; animation:pulseGlow 1s ease;}
@keyframes pulseGlow{0%{box-shadow:0 0 5px #22c55e; transform:scale(1);}50%{box-shadow:0 0 20px #22c55e;transform:scale(1.05);}100%{box-shadow:0 0 5px #22c55e;transform:scale(1);}}
.log{margin-top:20px;background:#020617;padding:10px;border-radius:8px;max-height:200px;overflow-y:auto;font-family:'Universal Sans', sans-serif;}
.manager-panel{margin-top:15px;text-align:center;background:#1e293b;padding:10px;border-radius:10px;}
.manager-panel span{margin-right:15px;font-weight:bold;}
.manager-panel a{background:linear-gradient(135deg,#facc15,#b45309); color: white; text-decoration: none; padding: 10px 15px; border-radius: 8px; font-family:'Universal Sans', sans-serif; cursor:pointer;}
#confirmPopup{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);align-items:center;justify-content:center;z-index:1000;}
#confirmPopup div{background:#1e293b;padding:30px;border-radius:15px;text-align:center;color:white;font-family:'Universal Sans', sans-serif;}
#confirmPopup button{margin:5px;padding:8px 15px;border-radius:8px;background:linear-gradient(135deg,#ef4444,#b91c1c);border:none;color:white;cursor:pointer;}
#confirmPopup button:hover{transform:scale(1.05);}
</style>
</head>
<body>
<div class="container">
<h1>Parts Power Up</h1>
<h2>Empowering Excellence in Parts Distribution</h2>

<div class="controls">
<select id="employee"></select>
<input id="amount" type="number" placeholder="Points">
<input id="reason" type="text" placeholder="Reason for change">
<button id="addBtn" onclick="add()">Add</button>
<button id="removeBtn" onclick="remove()">Remove</button>
</div>

<div class="manager-panel" id="managerPanel">
    <span>Manager: {{ current_user.name }}</span>
    <a href="/logout">Logout</a>
</div>

<div class="progress"><div id="progressFill" class="progress-fill"></div></div>
<div class="badges">
<span id="b25" class="badge">üî• Chill Tier (25)</span>
<span id="b50" class="badge">‚ö° Standard Tier (50)</span>
<span id="b75" class="badge">üöÄ Ludicrous Tier (75)</span>
<span id="b100" class="badge">üèÅ Plaid Tier (100)</span>
</div>
<div id="grid" class="grid"></div>
<div id="log" class="log"></div>
</div>

<!-- Confirmation Popup -->
<div id="confirmPopup">
  <div>
    <div id="confirmText" style="margin-bottom:20px;font-size:16px;"></div>
    <button onclick="confirmAction(true)">Confirm</button>
    <button onclick="confirmAction(false)">Cancel</button>
  </div>
</div>

<script>
let employees=[], currentEmployee=null;
let pendingAction=null;

async function loadEmployees(){
    const res = await fetch("/api/employees");
    employees = await res.json();
    const select = document.getElementById("employee");
    select.innerHTML = "";
    employees.forEach(emp => {
        const o = document.createElement("option");
        o.value = emp; o.textContent = emp;
        select.appendChild(o);
    });
    currentEmployee = employees[0];
    loadData();
}
document.getElementById("employee").addEventListener("change", e => {
    currentEmployee = e.target.value;
    loadData();
});

function getTier(i){ if(i<25) return "tier1"; if(i<50) return "tier2"; if(i<75) return "tier3"; return "tier4"; }

function buildGrid(points){
    const grid = document.getElementById("grid");
    grid.innerHTML = "";
    for(let i=0; i<100; i++){
        const cell = document.createElement("div");
        cell.className = "cell";
        const row = Math.floor(i/10), col = i%10;
        const index = (9-row)*10 + col;
        if(index < points){ cell.classList.add(getTier(index)); }
        grid.appendChild(cell);
    }
    document.getElementById("progressFill").style.width = points + "%";
    ["25","50","75","100"].forEach(v => {
        document.getElementById("b"+v).classList.toggle("unlocked", points >= v);
    });
}

async function loadData(){
    const res = await fetch(`/api/data/${currentEmployee}`);
    const data = await res.json();
    buildGrid(data.points);
    const log = document.getElementById("log");
    log.innerHTML = "";
    data.logs.forEach(l => {
        const div = document.createElement("div");
        div.textContent = `$${l.timestamp} | $${l.manager} | $${l.action} | Reason: $${l.reason}`;
        log.appendChild(div);
    });
}

function showConfirmation(actionType){
    const amount = document.getElementById("amount").value;
    const reason = document.getElementById("reason").value.trim();
    if(!amount || amount <= 0){ alert("Enter a valid points number"); return; }
    if(!reason){ alert("Please enter a reason"); return; }

    pendingAction = { type: actionType, amount, reason };
    const text = `$${actionType === "add" ? "Add" : "Remove"} $${amount} points for $${currentEmployee}?\nReason: $${reason}`;
    document.getElementById("confirmText").textContent = text;
    document.getElementById("confirmPopup").style.display = "flex";
}

function confirmAction(confirm){
    document.getElementById("confirmPopup").style.display = "none";
    if(confirm && pendingAction){
        if(pendingAction.type === "add") executeAdd(pendingAction.amount, pendingAction.reason);
        else executeRemove(pendingAction.amount, pendingAction.reason);
    }
    pendingAction = null;
    document.getElementById("reason").value = "";
    document.getElementById("amount").value = "";
}

async function executeAdd(amount, reason){
    await fetch("/api/add", {
        method: "POST", headers: {"Content-Type": "application/json"},
        body: JSON.stringify({employee: currentEmployee, amount, reason})
    });
    loadData();
}

async function executeRemove(amount, reason){
    await fetch("/api/remove", {
        method: "POST", headers: {"Content-Type": "application/json"},
        body: JSON.stringify({employee: currentEmployee, amount, reason})
    });
    loadData();
}

function add(){ showConfirmation("add"); }
function remove(){ showConfirmation("remove"); }

loadEmployees();
</script>
</body>
</html>